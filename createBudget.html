<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Proposal Generator</title>
<style>
    body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
    h1, h2 { color: #333; }
    hr { margin: 30px 0; }
    .proposal {
        margin-top: 30px;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background: #fafafa;

        h2 { margin-top: 0; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        table, th, td { border: 1px solid #999; }
        th, td { padding: 8px; text-align: left; }
    }

    form {
        .row {
            background: #def;
            padding: .3em 0;
            border-radius: .5em;
            margin: 1ex 0;
            border: medium solid #d9eafc;
            display: table;

            .prompt {
                display: table-cell;
                padding: 0 1em;
                font-size: 1em;
            }
            .prompt::after { content: ':' }

            span {
                /* float:left; */
                padding: 0 .5em;
            }

            label::after { content: ':' }

            input {
                width: 5em;
                background: #eef;
            }
        }
        /* .row:after {
            content: '';
            display: block;
            clear: both;
       } */
    }
    th::after { content: ':' }

</style>
</head>
<body>

<h1>Budget Proposal Generator</h1>

<hr>

<div class="form-container">
  <form id="proposalParmsForm">
    <button type="submit">Restore defaults</button>
    <template id="proposalRow">
      <div class="row">
        <h3 class="prompt"></h3>
        <p></p>
      </div>
    </template>
    <template id="proposalParmInput">
      <span>
        <label for="parm-">:</label>
        <input type="number" id="parm-" min="0" required>
      </span>
    </template>
  </form>
</div>

<div class="proposal" id="proposalContent">
    <!-- Generated proposal will appear here -->
</div>

<script>

  /**
   * Construct and handle interactions with a 2-D array of form inputs.
   */
  class Form {
    constructor (
      groups, // 2D array of input specs
      onChange // what to call on form update
    ) {
      this.groups = groups;
      this.build(onChange);
    }

    /**
     * Return value of form element named $member in group $group
     */
    get (groupDotMember) {
      const [group, member] = groupDotMember.split('.');
      const parm = this.inputsIndex[group][member];
      const value = parm.input.value;
      return parm.isFloat
        ? parseFloat(value)
        : parseInt(value);
    }

    /**
     * Construct form and register handlers.
     */
    build (onChange) {
      const form = document.getElementById("proposalParmsForm");
      const resetButton = form.querySelector('button[type=submit]');
      const rowTemplate = document.getElementById("proposalRow");
      const inputTemplate = document.getElementById("proposalParmInput");
      const searchParms = new URLSearchParams(window.location.search);
      
      this.inputsIndex = this.groups.reduce((groupIdx, group) => {
        const rowClone = rowTemplate.content.cloneNode(true);
        const rowPrompt = rowClone.querySelector(".prompt");
        rowPrompt.textContent = group.prompt;
        const row = rowClone.querySelector(".row");
        
        const memberIdx = group.members.reduce((memberIdx, parm) => {
          memberIdx[parm.name] = parm;
          parm.isFloat = parm.step && parseFloat(parm.step) %1 !== 0;
          
          const searchValue = !searchParms.has(parm.name)
                ? parm.defolt
                : parm.isFloat
                ? parseFloat(searchParms.get(parm.name))
                : parseInt(searchParms.get(parm.name));
          
          const id = "parm-" + group.name + '.' + parm.name;
          const inputClone = inputTemplate.content.cloneNode(true);
          
          const label = inputClone.querySelector("label");
          label.textContent = parm.prompt;
          label.setAttribute("for", id);
          
          const input = parm.input = inputClone.querySelector("input");
          input.setAttribute("id", id);
          for (const attr of ['step', 'min']) {
            if (parm[attr])
              input.setAttribute(attr, parm[attr]);
          }
          input.value = searchValue;
          input.dataset.parm = JSON.stringify(parm);
          input.addEventListener('input', evt => {
            const params = searchParms;
            params.set(parm.name, input.value);
            history.replaceState(null, '', window.location.pathname + '?' + params.toString());
            onChange(this);
          });
          
          row.appendChild(inputClone);
          return memberIdx;
        }, {});
        form.insertBefore(rowClone, resetButton);
        groupIdx[group.name] = memberIdx;
        return groupIdx;
      }, {});
      
      resetButton.addEventListener('submit', evt => {
        history.replaceState(null, '', window.location.pathname);
      });
    }
  }

  // Construct form with generateProposal as callback and call generateProposal once.
  window.addEventListener('load', evt => generateProposal(new Form([
    { name: "CoreDev", prompt: "Core Development", members: [
      { name: 'infra', defolt: 4, prompt: "Infrastructure dev (FTE months)" },
      { name: 'ui', defolt: 3, prompt: "Ui dev (FTE months)" } ] },
    { name: "org", prompt: "Collaborating Organizations", members: [
      { name: 'count', defolt: 5, prompt: "Number" },
      { name: 'meets', defolt: 2, prompt: "meetings per org" } ] },
    { name: "format", prompt: "Compatible Formats", members: [
      { name: 'count', defolt: 3, prompt: "Number" },
      { name: 'meets', defolt: 2, prompt: "meetings per format" },
      { name: 'infra', defolt: 2, prompt: "infrastruture (FTE months)" },
      { name: 'ui', defolt: 1, prompt: "user interface (FTE months)" } ] },
    { name: "Personel", prompt: "Personel", members: [
      { name: 'salary', defolt: 70000, prompt: "FTE billing €/year" },
      { name: 'workDays', defolt: 220, prompt: "workdays / year" } ] },
    { name: "meetLogistics", prompt: "Meetings", members: [
      { name: 'travelDays', defolt: 3, prompt: "average travel duration (days)" },
      { name: 'hotelNight', defolt: 130, prompt: "average hotel cost €/night" },
      { name: 'perDiem', defolt: 60, prompt: "per diem €/day" },
      { name: 'transport', defolt: 250, prompt: "transportation €/trip" },
      { name: 'meetStaff', defolt: 2, prompt: "number of staff", step: 0.1, min: 1.0 } ] },
  ], generateProposal)));

  /**
   * Ugly-ish way to construct the proposal text; sets element innerHTML directly.
   */
  function  generateProposal (form) {
    const G = form.get.bind(form); // make accesses below more terse, e.g. G('format.count')

    const dailyRate = G('Personel.salary') / G('Personel.workDays');

    const engineeringTime = (G('CoreDev.infra') + G('CoreDev.ui') + G('format.infra')*G('format.count') + G('format.ui')*G('format.count'));
    const engineeringCost = engineeringTime * (G('Personel.salary')/12);
    const travelCostPerMeeting = G('meetLogistics.transport') + (G('meetLogistics.travelDays')*G('meetLogistics.hotelNight')) + (G('meetLogistics.travelDays')*G('meetLogistics.perDiem')); // travel + hotel + per diem

    const meetings = G('org.meets')*G('org.count') + G('format.meets')*G('format.count');
    const travelCost = meetings * travelCostPerMeeting;
    const meetingStaffDays = (meetings * G('meetLogistics.meetStaff')).toFixed(2);
    const meetingStaffCost = meetingStaffDays * dailyRate;

    const totalCost = (travelCost + meetingStaffCost + engineeringCost).toFixed(0);

    const proposalHTML = `
  <h2>Proposal: Establishment of a (@@what's the breadth of this?) Data Exchange Standard</h2>

  <h3>1. Executive Summary</h3>
  <p>
    This proposal outlines the estimated resources, time, and costs required to establish a data exchange standard across <strong>${G('org.count')}</strong> organizations and <strong>${G('format.count')}</strong> target format.
    The project includes coordination meetings, infrastructure development, user interface (UI) work, and format-specific engineering.
  </p>

  <h3>2. Scope of Work</h3>
  <table>
    <li>Stakeholder engagement: ${G('org.meets')} meetings per organization and ${G('format.meets')} meetings per format.</li>
    <li>Travel & subsistence for project team members attending stakeholder sessions.</li>
    <li>Infrastructure engineering: Core back-end and data exchange infrastructure.</li>
    <li>User Interface (UI) development: Reference implementation for interacting with the data exchange.</li>
    <li>Format-specific engineering and UI adjustments.</li>
  </table>

  <h3>3. Resource Requirements</h3>
  <table>
    <tr><td>              </td><td>core                 </td><td> </td><td>${G('org.count')} org                                                                </td><td> </td><td>${G('format.count')} format                                                                            </td><td> </td><td>                                                                                                                                                              </td></tr> 
    <tr><th>Infrastructure</th><td>${G('CoreDev.infra')}</td><td>+</td><td>0                                                                                    </td><td>+</td><td>${G('format.infra')} months per format X ${G('format.count')} = ${G('format.infra')*G('format.count')} </td><td>=</td><td> ${G('CoreDev.infra') + G('format.infra')*G('format.count')} months FTE                                                                                       </td></tr>
    <tr><th>UI            </th><td>${G('CoreDev.ui')}   </td><td>+</td><td>0                                                                                    </td><td>+</td><td>${G('format.ui')   } months per format X ${G('format.count')} = ${G('format.ui')   *G('format.count')} </td><td>=</td><td> ${G('CoreDev.ui')             + G('format.ui')   *G('format.count')} months FTE                                                                              </td></tr>
    <tr><th>F2F Meetings  </th><td>0                    </td><td>+</td><td>${G('org.meets')} F2Fs per org * ${G('org.count')} = ${G('org.meets')*G('org.count')}</td><td>+</td><td>${G('format.meets')} F2F per format    X ${G('format.count')} = ${G('format.meets')*G('format.count')} </td><td>=</td><td> ${G('org.meets')*G('org.count') + G('format.meets')*G('format.count') } * ${G('meetLogistics.meetStaff')} staff per meeting = ${meetingStaffDays} staff-days </td></tr>
  </table>

  <h3>4. Cost Estimate</h3>
  <table>
    <tr><th>Component</th><th>Cost (€)</th></tr>
    <tr><td>Travel & subsistence (${meetings} meetings)</td><td>${travelCost.toFixed(0)}</td></tr>
    <tr><td>Staff time – meetings (${meetingStaffDays} days)</td><td>${meetingStaffCost.toFixed(0)}</td></tr>
    <tr><td>Engineering & UI (FTEs)</td><td>${engineeringCost.toFixed(0)}</td></tr>
    <tr><th>Total Project Estimate</th><th>${totalCost}</th></tr>
  </table>

  <h3>5. Assumptions</h3>
  <ul>
    <li>Billing rate: ${G('Personel.salary')} €/year (~${dailyRate.toFixed(0)} €/day).</li>
    <li>Hotel: ${G('meetLogistics.hotelNight')} €/night, ${G('meetLogistics.travelDays')} nights per meeting.</li>
    <li>Per diem: ${G('meetLogistics.perDiem')} €/day, ${G('meetLogistics.travelDays')} days per meeting.</li>
    <li>Travel: ${G('meetLogistics.transport')} €/meeting within Europe.</li>
  </ul>`;
    document.getElementById('proposalContent').innerHTML = proposalHTML;
  }
</script>

</body>
</html>
