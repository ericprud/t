<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Proposal Generator</title>
<style>
    body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
    h1, h2 { color: #333; }
    hr { margin: 30px 0; }
    .proposal {
        margin-top: 30px;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background: #fafafa;

        h2 { margin-top: 0; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        table, th, td { border: 1px solid #999; }
        th, td { padding: 8px; text-align: left; }
    }

    form {
        .row {
            background: #def;
            padding: .3em 0;
            border-radius: .5em;
            margin: 1ex 0;
            border: medium solid #d9eafc;
            display: table;

            .prompt {
                display: table-cell;
                padding: 0 1em;
                font-size: 1em;
            }
            .prompt::after { content: ':' }

            span {
                /* float:left; */
                padding: 0 .5em;
            }

            label::after { content: ':' }

            input {
                width: 5em;
                background: #eef;
            }
        }
        /* .row:after {
            content: '';
            display: block;
            clear: both;
       } */
    }

</style>
</head>
<body>

<h1>Budget Proposal Generator</h1>

<hr>

<div class="form-container">
  <form id="proposalParmsForm">
    <button type="submit">Restore defaults</button>
    <template id="proposalRow">
      <div class="row">
        <h3 class="prompt"></h3>
        <p></p>
      </div>
    </template>
    <template id="proposalParmInput">
      <span>
        <label for="parm-">:</label>
        <input type="number" id="parm-" min="0" required>
      </span>
    </template>
  </form>
</div>

<div class="proposal" id="proposalContent">
    <!-- Generated proposal will appear here -->
</div>

<script>
  const ParameterGroupList = [
    { prompt: "Core Development", members: [
      { name: 'infrastructure', defolt: 4, prompt: "Infrastructure dev (FTE months)" },
      { name: 'ui', defolt: 3, prompt: "Ui dev (FTE months)" } ] },
    { prompt: "Collaborating Organizations", members: [
      { name: 'nOrgs', defolt: 5, prompt: "Number" },
      { name: 'orgMeets', defolt: 2, prompt: "meetings per org" } ] },
    { prompt: "Compatible Formats", members: [
      { name: 'nFormats', defolt: 3, prompt: "Number" },
      { name: 'formatMeets', defolt: 2, prompt: "meetings per format" },
      { name: 'formatInfra', defolt: 2, prompt: "infrastruture (FTE months)" },
      { name: 'formatUi', defolt: 1, prompt: "user interface (FTE months)" } ] },
    { prompt: "Personel", members: [
      { name: 'salary', defolt: 70000, prompt: "FTE billing €/year" } ] },
    { prompt: "Meetings", members: [
      { name: 'travelDays', defolt: 3, prompt: "average travel duration (days)" },
      { name: 'hotelNight', defolt: 130, prompt: "average hotel cost €/night" },
      { name: 'perDiem', defolt: 60, prompt: "per diem €/day" },
      { name: 'transport', defolt: 250, prompt: "transportation €/trip" },
      { name: 'meetStaff', defolt: 2, prompt: "number of staff" } ] },
  ];
  const CurrentParms = {};
  
  const form = document.getElementById("proposalParmsForm");
  const resetButton = form.querySelector('button[type=submit]');
  const rowTemplate = document.getElementById("proposalRow");
  const inputTemplate = document.getElementById("proposalParmInput");
  const searchParms = new URLSearchParams(window.location.search);

  const cloneLists = ParameterGroupList.map(group => {
    const rowClone = rowTemplate.content.cloneNode(true);
    const rowPrompt = rowClone.querySelector(".prompt");
    rowPrompt.textContent = group.prompt;
    const row = rowClone.querySelector(".row");

    const inputClones = group.members.map(parm => {
      const searchValue = searchParms.has(parm.name)
            ? parseInt(searchParms.get(parm.name))
            : parm.defolt;
      CurrentParms[parm.name] = searchValue;
      
      const id = "parm-" + parm.name;
      const inputClone = inputTemplate.content.cloneNode(true);
      
      const label = inputClone.querySelector("label");
      label.textContent = parm.prompt;
      label.setAttribute("for", id);

      const input = inputClone.querySelector("input");
      input.setAttribute("id", id);
      input.value = searchValue;
      input.dataset.parm = parm;
      input.addEventListener('input', evt => {
        const params = searchParms;
        params.set(parm.name, input.value);
        history.replaceState(null, '', window.location.pathname + '?' + params.toString());
        
        const updatedValue = parseInt(input.value);
        CurrentParms[parm.name] = updatedValue;
        generateProposal(CurrentParms);
      });
      
      row.appendChild(inputClone);
      return inputClone;
    });
    form.insertBefore(rowClone, resetButton);
    return inputClones;
  });

  console.log(cloneLists);
  resetButton.addEventListener('submit', evt => {
    history.replaceState(null, '', window.location.pathname);
  });

  function generateProposal(parms) {

    const workDaysPerYear = 220;
    const dailyRate = parms.salary / workDaysPerYear;
    const travelCostPerMeeting = parms.transport + (parms.travelDays*parms.hotelNight) + (parms.travelDays*parms.perDiem); // travel + hotel + per diem

    const meetings = parms.orgMeets*parms.nOrgs + parms.formatMeets*parms.nFormats;
    const travelCost = meetings * travelCostPerMeeting;
    const meetingStaffDays = meetings * parms.meetStaff;
    const meetingStaffCost = meetingStaffDays * dailyRate;
    
    const infrastructureFTE = parms.infrastructure; // months
    const uiFTE = parms.ui; // months
    const formatEngineeringFTE = parms.formatInfra*parms.nFormats; // 2 months per format
    const formatUIFTE = parms.formatUi*parms.nFormats; // 1 month per format
    
    const engineeringCost = (parms.infrastructure + uiFTE + formatEngineeringFTE + formatUIFTE) * (parms.salary/12);
    
    const totalCost = travelCost + meetingStaffCost + engineeringCost;
    
    const proposalHTML = `
  <h2>Proposal: Establishment of a Data (@@what's the breadth of this?) Exchange Standard</h2>

            <h3>1. Executive Summary</h3>
            <p>This proposal outlines the estimated resources, time, and costs required to establish a data exchange standard across <strong>${parms.nOrgs}</strong> organizations and <strong>${parms.nFormats}</strong> target formats. The project includes coordination meetings, infrastructure development, user interface (UI) work, and format-specific engineering.</p>

            <h3>2. Scope of Work</h3>
            <ul>
  <li>Stakeholder engagement: ${parms.orgMeets} meetings per organization and ${parms.formatMeets} meetings per format.</li>
                <li>Travel & subsistence for project team members attending stakeholder sessions.</li>
                <li>Infrastructure engineering: Core back-end and data exchange infrastructure.</li>
                <li>User Interface (UI) development: Reference implementation for interacting with the data exchange.</li>
                <li>Format-specific engineering and UI adjustments.</li>
            </ul>

            <h3>3. Resource Requirements</h3>
            <ul>
  <li>Infrastructure Engineering: ${parms.infrastructure} months FTE</li>
  <li>UI Engineering (core): ${parms.ui} months FTE</li>
  <li>Format Engineering: ${parms.formatInfra} months/format × ${parms.nFormats} formats = ${formatEngineeringFTE} months FTE</li>
  <li>Format-specific UI: ${parms.formatUi} month/format × ${parms.nFormats} formats = ${formatUIFTE} months FTE</li>
                <li>Meetings/Coordination: ${meetingStaffDays} staff-days</li>
            </ul>

            <h3>4. Cost Estimate</h3>
            <table>
                <tr><th>Component</th><th>Cost (€)</th></tr>
                <tr><td>Travel & subsistence (${meetings} meetings)</td><td>${travelCost.toFixed(0)}</td></tr>
                <tr><td>Staff time – meetings (${meetingStaffDays} days)</td><td>${meetingStaffCost.toFixed(0)}</td></tr>
                <tr><td>Engineering & UI (FTEs)</td><td>${engineeringCost.toFixed(0)}</td></tr>
                <tr><th>Total Project Estimate</th><th>${totalCost.toFixed(0)}</th></tr>
            </table>

            <h3>5. Assumptions & Exclusions</h3>
            <ul>
                <li>Billing rate: ${parms.salary} €/year (~${dailyRate.toFixed(0)} €/day).</li>
                <li>Hotel: ${parms.hotelNight} €/night, ${parms.travelDays} nights per meeting.</li>
                <li>Per diem: ${parms.perDiem} €/day, ${parms.travelDays} days per meeting.</li>
                <li>Travel: ${parms.transport} €/meeting within Europe.</li>
            </ul>
        `;
    document.getElementById('proposalContent').innerHTML = proposalHTML;
  }
  
  window.addEventListener('load', evt => {generateProposal(CurrentParms)});
</script>

</body>
</html>
